<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"[]>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Windows10 IoT Core on RPi2のSPIのパフォーマンス — ふがふが</title>
    <link rel="stylesheet" href="../css/style.css" type="text/css" />
    <link rel="stylesheet" href="../css/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js">
    </script>
    <script type="text/javascript" src="../_static/underscore.js">
    </script>
    <script type="text/javascript" src="../_static/doctools.js">
    </script>
    <link rel="top" title="ふがふが" href="../index.html" />
    <link rel="up" title=".NET/WinRT関係" href="../net.html" />
    <link rel="next" title="AVR関係" href="../avr.html" />
    <link rel="prev" title="Windows 10 IoT Core Preview版でBLEのAdvertisementを受信する" href="win10_iot_core_previw_ble.html" />
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index" accesskey="I">index</a>
        </li>
        <li class="right">
          <a href="../avr.html" title="AVR関係" accesskey="N">next</a> |</li>
        <li class="right">
          <a href="win10_iot_core_previw_ble.html" title="Windows 10 IoT Core Preview版でBLEのAdvertisementを受信する" accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0">
          <a href="../index.html">ふがふが</a> »</li>
        <li class="nav-item nav-item-1">
          <a href="../net.html" accesskey="U">.NET/WinRT関係</a> »</li>
      </ul>
    </div>
    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            <div class="section" id="windows10-iot-core-on-rpi2spi">
              <h1>Windows10 IoT Core on RPi2のSPIのパフォーマンス<a class="headerlink" href="#windows10-iot-core-on-rpi2spi" title="Permalink to this headline">¶</a></h1>
              <div class="section" id="id1">
                <h2>概要<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
                <p>Windows 10 IoT CoreのSPI経由でセンサデータを取得する際にどれくらいのデータが転送できるかを確認するため、SPIのスループットを計測してみた。
(書きかけ)</p>
              </div>
              <div class="section" id="id2">
                <h2>作ったもの<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
                <p>ソースコードは <a class="reference external" href="https://github.com/ciniml/IoTCoreIoTest">GitHubのリポジトリ</a> にて公開している。</p>
                <ul>
                  <li>
                    <dl class="first docutils">
                      <dt>受信したAdvertisementの送信元BLEデバイスの名前とアドレス、RSSI値を表示するアプリケーション</dt>
                      <dd>
                        <ul class="first last simple">
                          <li>Windows 10 IoT CoreもしくはWindows10TP上で動作する。</li>
                        </ul>
                      </dd>
                    </dl>
                  </li>
                  <li>
                    <dl class="first docutils">
                      <dt>Windows 10 IoT Coreで特定のVID/PIDを持つデバイス用に標準BluetoothドライバをインストールするためのINFファイル生成ツール</dt>
                      <dd>
                        <ul class="first last simple">
                          <li>Windows 10 IoT Coreのシステム上にある <em>BTH_MC.inf</em> に後述の手順の加工を施したものを生成する</li>
                        </ul>
                      </dd>
                    </dl>
                  </li>
                </ul>
              </div>
              <div class="section" id="id3">
                <h2>計測内容<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
                <p>Interface誌の10月号の特集にて、30[MHz]のSPIの信号をRPi2から出力して波形を測定していたので、同様にWindows 10 IoT CoreをSPIマスタとして信号を出力して測定してみた。
SpiDeviceクラスの出力用メソッドには以下の3種類があるため、それぞれでどう変化するかを測定した。</p>
                <ul class="simple">
                  <li>Write</li>
                  <li>TransferFullDuplex</li>
                  <li>TransferSequential</li>
                </ul>
              </div>
              <div class="section" id="id4">
                <h2>結果<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
                <p>とても遅い。
30[MHz]なのでせめて20[Mbps]程度は出てほしいものであるが、1[Mbps]程度しか出ていない。</p>
                <p>さすがにもう少しスループットが出るものだと思っていたので、なぜ遅いのか原因を調べてみることにした。</p>
              </div>
              <div class="section" id="id5">
                <h2>割り込み頻度の測定<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
                <p>スループットが出ていない原因として考えられるのが、SPIペリフェラルのドライバ(bcmspi.sys)がDMAを使用せず、PIO転送を行っている可能性である。
このような場合、SPIの転送完了割り込みで次のデータを設定している可能性が高いので、割り込みタイミングを確認することにした。</p>
                <p>幸い、Windows 10 IoT Coreでは非常に簡単にETW <a class="footnote-reference" href="#etw" id="id6">[1]</a> によるパフォーマンストレースが取得できるので、パフォーマンストレースを取得して解析することにする。</p>
                <p>まず、ブラウザから <cite>&lt;RPi2のIPアドレス&gt;:8080</cite> にアクセスしてWebBを表示する。</p>
                <p class="rubric">脚注</p>
                <table class="docutils footnote" frame="void" id="etw" rules="none">
                  <colgroup>
                    <col class="label" />
                    <col />
                  </colgroup>
                  <tbody valign="top">
                    <tr>
                      <td class="label">
                        <a class="fn-backref" href="#id6">[1]</a>
                      </td>
                      <td>
                        <a class="reference external" href="http://www.atmarkit.co.jp/fdotnet/chushin/vsperf_01/vsperf_01_02.html">第1回　OS機能によるアプリのパフォーマンス測定</a>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
          <h3>
            <a href="../index.html">Table Of Contents</a>
          </h3>
          <ul>
            <li>
              <a class="reference internal" href="#">Windows10 IoT Core on RPi2のSPIのパフォーマンス</a>
              <ul>
                <li>
                  <a class="reference internal" href="#id1">概要</a>
                </li>
                <li>
                  <a class="reference internal" href="#id2">作ったもの</a>
                </li>
                <li>
                  <a class="reference internal" href="#id3">計測内容</a>
                </li>
                <li>
                  <a class="reference internal" href="#id4">結果</a>
                </li>
                <li>
                  <a class="reference internal" href="#id5">割り込み頻度の測定</a>
                </li>
              </ul>
            </li>
          </ul>
          <h4>Previous topic</h4>
          <p class="topless">
            <a href="win10_iot_core_previw_ble.html" title="previous chapter">Windows 10 IoT Core Preview版でBLEのAdvertisementを受信する</a>
          </p>
          <h4>Next topic</h4>
          <p class="topless">
            <a href="../avr.html" title="next chapter">AVR関係</a>
          </p>
          <div role="note" aria-label="source link">
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li>
                <a href="../_sources/net/win10_iot_core_spi.txt" rel="nofollow">Show Source</a>
              </li>
            </ul>
          </div>
          <div id="searchbox" style="display: none" role="search">
            <h3>Quick search</h3>
            <form class="search" action="../search.html" method="get">
              <input type="text" name="q" />
              <input type="submit" value="Go" />
              <input type="hidden" name="check_keywords" value="yes" />
              <input type="hidden" name="area" value="default" />
            </form>
            <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer">
      </div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index">index</a>
        </li>
        <li class="right">
          <a href="../avr.html" title="AVR関係">next</a> |</li>
        <li class="right">
          <a href="win10_iot_core_previw_ble.html" title="Windows 10 IoT Core Preview版でBLEのAdvertisementを受信する">previous</a> |</li>
        <li class="nav-item nav-item-0">
          <a href="../index.html">ふがふが</a> »</li>
        <li class="nav-item nav-item-1">
          <a href="../net.html">.NET/WinRT関係</a> »</li>
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        © Copyright 2014, Kenta IDA.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>